name: Deploy to Production

on:
  workflow_dispatch:  # ejecuci√≥n manual

permissions:
  contents: read
  id-token: write

jobs:
  deploy_prod:
    runs-on: ubuntu-latest

    env:
      NG_APP_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      NG_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
      NG_APP_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      NG_APP_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      NG_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
      NG_APP_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
      NG_APP_THEMOVIEDB_API_KEY: ${{ secrets.THEMOVIEDB_API_KEY }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # üß† Verificaci√≥n de que se est√° desplegando una TAG
      - name: Check if current ref is a tag
        run: |
          echo "Current ref: $GITHUB_REF"
          if [[ "$GITHUB_REF" != refs/tags/* ]]; then
            echo "‚ùå Error: This workflow must be triggered from a tag (e.g. v1.0.0)"
            exit 1
          fi
          echo "‚úÖ Tag detected: ${GITHUB_REF#refs/tags/}"

      - name: Download latest release asset
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          tag: ${{ github.ref_name }}
          fileName: "app-dist.zip"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unzip build
        run: unzip app-dist.zip -d ./dist

      # ‚öôÔ∏è Generamos el environment de producci√≥n
      - name: Generate environment file for PROD
        run: node scripts/set-env.cjs "${GITHUB_REF#refs/tags/}"

      - name: Deploy to Firebase Hosting
        uses: w9jds/firebase-action@v13.15.3
        with:
          args: deploy --only hosting -P 'prod'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
